# Muxcore: 多协议复用网络框架
> all codes and docs generated by TRAE

Muxcore是一个高性能、可扩展的多协议复用网络框架，支持在同一端口上处理HTTP/1.x/2、WebSocket、gRPC以及自定义协议。

## 架构概述

![架构图](https://i.imgur.com/architecture.png)

Muxcore的核心架构包括：

1. **Listener**: 监听传入连接
2. **Smart Protocol Detector**: 智能协议检测器，识别连接使用的协议
3. **Protocol Handlers**: 协议处理器，处理不同类型的协议
4. **Connection Pool**: 连接池，管理所有活跃连接
5. **Control Plane**: 控制平面，负责配置和监控
6. **Observability**: 可观测性组件，提供指标、追踪和日志功能
7. **Security Layer**: 安全层，提供TLS卸载和身份验证

## 核心功能

- **多协议支持**: HTTP/1.x/2、WebSocket、gRPC和自定义协议
- **智能协议检测**: 自动识别连接使用的协议
- **连接池管理**: 高效管理连接资源
- **负载均衡**: 内置简单负载均衡机制
- **可观测性**: 集成指标、追踪和日志
- **可扩展**: 易于添加新的协议处理器和功能
- **安全**: 支持TLS和身份验证

## 快速开始

### 前提条件

- Go 1.24.5或更高版本

### 安装

```bash
# 克隆仓库
git clone https://github.com/cocowh/muxcore.git
cd muxcore

# 安装依赖
go mod tidy
```

### 构建

```bash
# 构建项目
go build ./cmd/muxcore
```

### 使用命令行工具

MuxCore 现在提供了基于 Cobra 的现代命令行界面：

```bash
# 查看帮助信息
./muxcore --help

# 查看版本信息
./muxcore version

# 启动服务器
./muxcore serve

# 使用自定义配置文件启动
./muxcore serve --config /path/to/config.yaml

# 启用详细日志
./muxcore serve --verbose

# 设置日志级别
./muxcore serve --log-level debug

# 验证配置文件
./muxcore config validate
```

#### 可用命令

- `serve`: 启动 MuxCore 服务器
- `version`: 显示版本信息
- `config validate`: 验证配置文件
- `help`: 显示帮助信息

#### 全局选项

- `-c, --config`: 配置文件路径 (默认: "config.yaml")
- `-v, --verbose`: 启用详细输出
- `--log-level`: 日志级别 (trace, debug, info, warn, error, fatal)

#### serve 命令选项

- `--bind`: 覆盖配置中的绑定地址
- `--port`: 覆盖配置中的端口
- `--daemon`: 以守护进程模式运行

### 运行

```bash
# 使用默认配置运行
./muxcore

# 使用自定义配置运行
./muxcore --config path/to/config.yaml
```

## 配置说明

配置文件使用YAML格式，以下是主要配置项：

```yaml
server:
  address: ":8080"  # 监听地址和端口
  read_timeout: 30  # 读取超时时间(秒)
  write_timeout: 30  # 写入超时时间(秒)
  idle_timeout: 60  # 空闲超时时间(秒)

monitor:
  interval: 10  # 监控间隔(秒)

logger:
  level: "info"  # 日志级别
  output: "stdout"  # 输出位置
  file_path: "/var/log/muxcore"  # 日志文件路径
  max_size: 100  # 单个日志文件最大大小(MB)
  max_age: 7  # 日志文件保留天数

protocols:
  http:
    enabled: true
    max_connections: 1000
  websocket:
    enabled: true
    max_connections: 500
  grpc:
    enabled: true
    max_connections: 500
  custom:
    enabled: false

security:
  tls:
    enabled: false
    cert_file: "cert.pem"
    key_file: "key.pem"
  auth:
    enabled: false
    jwt_secret: "your-secret-key"
```

## 使用示例

### HTTP服务

```go
// 创建HTTP路由器	httpRouter := router.NewHTTPRouter()
// 添加路由
httpRouter.GET("/", func(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintf(w, "Hello, World!")
})
// 创建HTTP处理器
httpHandler := handlers.NewHTTPHandler(controlPlane.GetPool(), httpRouter)
// 注册处理器
detector.RegisterHandler("http", httpHandler)
```

### WebSocket服务

```go
// 创建消息总线
messageBus := bus.NewMessageBus()
// 创建WebSocket处理器
wsHandler := handlers.NewWebSocketHandler(controlPlane.GetPool(), messageBus)
// 注册处理器
detector.RegisterHandler("websocket", wsHandler)
```

### gRPC服务

```go
// 创建gRPC处理器
grpcHandler := handlers.NewGRPCHandler(controlPlane.GetPool())
// 添加拦截器
grpcHandler.AddInterceptor(interceptor.NewLoggingInterceptor())
// 注册处理器
detector.RegisterHandler("grpc", grpcHandler)
// 注册gRPC服务
grpcHandler.RegisterService(&pb.EchoService_ServiceDesc, &echoServiceServer{})
```

## 贡献指南

1.  Fork仓库
2.  创建特性分支
3.  提交更改
4.  推送到分支
5.  创建Pull Request

## 许可证

[MIT](LICENSE)
